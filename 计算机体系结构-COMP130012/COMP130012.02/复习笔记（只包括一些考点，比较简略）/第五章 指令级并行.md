# 第五章 指令级并行

>  这位更是重量级。   —Tiger the ParaBoy

```
第五章 重点，与chapter3结合
循环展开、冒险等概念
为什么会有这些冲突

指令调度，每年都考，书上与ppt例题，给出一张ppt23的表格，告诉延迟等一系列条件。分支延迟如果不说，肯定都是要考虑的！！！**

ppt26的最后一个stall其实是流水线上的【都要好好理解】
先不调度的、然后不展开调度的、然后展开最少次数（一般展开四次都可以展开完，但要求是最少次数）
后面都是概念

tomasulo算法要理解！！！工作原理、怎么做
可能考给出一个图ppt70，然后一步步怎么做，列出来在做什么

ppt91这种伪代码实现不考，
硬件推测——乱序执行、顺序提交
提交次序
超长指令字如何调度

ppt117
只要每一行不空就行【作业做过的一定是重点】
ppt122、ppt123一定要掌握，没有推测如何执行、有推测如何执行
ppt128会给出条件

后面的不用看
多线程  选择题、多粒度、优缺点
13节ARM这种不考
```

## 概念

指令级并行ILP：Instruction Level Parallelism
指令之间可以重叠执行

两种开发方法：

- 硬件动态发现
- 软件在编译时静态发现

硬件软件结合，最大限度开发程序的指令级并行

流水线实际上的CPI，要考虑各种冒险带来的停顿
$$
CPI_{流水线}=CPI_{理想}+停顿_{结构冲突}+停顿_{数据冲突}+停顿_{控制冲突}
$$
相关：两条指令之间存在某种依赖关系。如果两条指令相关，则它们就有可能不能在流水线中重叠执行或者只能部分重叠执行。

冒险：流水线的那几种：结构、数据、控制

关系：相关是程序的一种属性，它反映了程序中指令之间的相互依赖关系。某种给定相关是否会导致实际冒险的发生，以及该冒险会带来多长的停顿，则是流水线结构的属性。

- 数据相关(真数据相关)：后面的指令使用了前面的指令的结果

- 名称相关：如果两条指令使用相同的名称（指令所访问的寄存器或存储器单元的名称），但是**它们之间并没有数据流动**（和数据相关的区别所在），则称这两条指令存在名称相关。i 在前，j 在后

  - 反相关：j写=i读
  - 输出相关：j写=i写

  名称相关的两条指令之间并没有数据的传送。如果一条指令中的名称改变了，并不影响另外一条指令的执行。

  换名技术

- 控制相关

**数据冒险**：指令间存在**名称相关**或**数据相关**，当相关的指令靠得足够近时，它们在流水线中的重叠执行或者重新排序会**改变指令读/写操作数的顺序**，使之不同于它们非流水实现时的顺序，则发生了数据冒险。

三种类型：

- 写后读（RAW）：在 i 写入之前，j 先去读。j 读出的内容是错误的
- 写后写（WAW）：在 i 写入之前，j 先写。 最后写入的结果是 i 的。这种冲突对应名称相关的输出相关(j写=i写)。
- 读后写（WAR）：在 i 读之前，j 先写。 i 读出的内容是错误的！ 由名称相关的反相关(j写=i读)引起。

## 控制相关

除了程序包第一基本块中的指令（p1）外，其他指令斗鱼某组分支存在控制相关。

```c
if p1 { S1; };  //S1与p1控制相关
if p2 { S2; };  //S2与p2控制相关
```

与一条分支指令控制相关的指令不能被移到该分支   之前，否则这些指令就不受该分支控制了。       

如then部分中的指令不能移到if语句之前。

如果一条指令与某分支指令不存在控制相关，就不    能把该指令移到该分支之后。

如if前的语句不能移到then部分

在不影响程序正确性的情况下，可能希望执行一些还不应当执行的指令，从而违反控制相关。因此，**控制相关并不是一个必须严格保持的关键属性**。

对于正确地执行程序来说，必须保持的最关键的两个属性是：**数据流**和**异常行为**。

异常行为：如果不维护R2数据相关，就会改变异常发生行为。

```assembly
    DADDU R2,R3,R4
    BEQZ  R2,L1
    LW		R1,0(R2)
L1:
```

## 基本流水线调度和循环展开

充分开发指令之间存在的并行性，找出不相关的指令序列，让它们在流水线上重叠并行执行。 

增加指令间并行性最简单和最常用的方法

- 开发循环级并行性——循环的不同迭代之间存在的并行性。
- 在把循环展开后，通过重命名和指令调度来开发更多的并行性。

## 动态调度

静态调度流水线：提取指令、发射。检测到不能隐藏的数据相关，停顿。

动态调度：重排指令顺序。保持数据流和异常行为。

Tomasulu算法

- 记录和检测指令相关，操作数一旦就绪就立即执行，把发生RAW冒险的可能性减少到最小
- 通过寄存器换名来消除WAR冒险和WAW冒险。



基于硬件的推测

Tomasulu算法改进

允许指令乱序执行，但必须顺序提交（确认）。

引入ROB 重排序缓冲区		

---

例题：

![image-20220607231427715](%E7%AC%AC%E4%BA%94%E7%AB%A0%20%E6%8C%87%E4%BB%A4%E7%BA%A7%E5%B9%B6%E8%A1%8C.assets/image-20220607231427715.png)

![image-20220607232349219](%E7%AC%AC%E4%BA%94%E7%AB%A0%20%E6%8C%87%E4%BB%A4%E7%BA%A7%E5%B9%B6%E8%A1%8C.assets/image-20220607232349219.png)
